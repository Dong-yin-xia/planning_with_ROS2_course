# 项目话题通信架构说明

## 整体架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                    规划系统话题通信架构                          │
└─────────────────────────────────────────────────────────────────┘

【启动组1: planning命名空间】
┌─────────────────────────────────────────────────────────────────┐
│  pnc_map_server_node                                            │
│  ├─ 发布话题:                                                   │
│  │  ├─ /planning/pnc_map (base_msgs::msg::PNCMap)              │
│  │  └─ /planning/pnc_map_markerarray (MarkerArray)             │
│  └─ 提供服务:                                                   │
│     └─ /planning/pnc_map_service (PNCMapService)               │
└─────────────────────────────────────────────────────────────────┘
         │ 服务调用
         ↓
┌─────────────────────────────────────────────────────────────────┐
│  planning_process (核心规划节点)                                 │
│  ├─ 订阅服务:                                                   │
│  │  ├─ /planning/pnc_map_service (客户端)                      │
│  │  └─ /planning/global_path_service (客户端)                  │
│  ├─ 发布话题:                                                   │
│  │  ├─ /planning/reference_line (nav_msgs::msg::Path)          │
│  │  ├─ /planning/local_path (nav_msgs::msg::Path)             │
│  │  └─ /planning/local_trajectory (LocalTrajectory)            │
│  └─ TF操作:                                                     │
│     ├─ 监听TF (获取车辆和障碍物位姿)                             │
│     └─ 广播静态TF (车辆初始化)                                   │
└─────────────────────────────────────────────────────────────────┘
         │ 服务调用
         ↓
┌─────────────────────────────────────────────────────────────────┐
│  global_path_server_node                                        │
│  ├─ 发布话题:                                                   │
│  │  ├─ /planning/global_path (nav_msgs::msg::Path)             │
│  │  └─ /planning/global_path_rviz (Marker)                      │
│  └─ 提供服务:                                                   │
│     └─ /planning/global_path_service (GlobalPathService)       │
└─────────────────────────────────────────────────────────────────┘

【启动组2: move_cmd_launch.py】
┌─────────────────────────────────────────────────────────────────┐
│  car_move_cmd_node                                              │
│  ├─ 订阅话题:                                                   │
│  │  └─ /planning/local_trajectory (LocalTrajectory)            │
│  └─ TF操作:                                                     │
│     └─ 广播主车TF (base_footprint)                              │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│  obs_move_cmd_node                                              │
│  └─ TF操作:                                                     │
│     └─ 定时广播3辆障碍物TF (base_footprint_obs1/2/3)            │
└─────────────────────────────────────────────────────────────────┘

【可视化】
┌─────────────────────────────────────────────────────────────────┐
│  RViz2                                                          │
│  └─ 订阅所有可视化话题进行显示                                   │
└─────────────────────────────────────────────────────────────────┘
```

## 详细话题列表

### 1. 发布话题（Publisher）

#### 1.1 PNC地图相关话题
**节点**: `pnc_map_server_node`  
**命名空间**: `/planning`

| 话题名称 | 消息类型 | 用途 | 发布频率 |
|---------|---------|------|---------|
| `/planning/pnc_map` | `base_msgs::msg::PNCMap` | 规划模块使用的地图数据 | 服务响应时发布 |
| `/planning/pnc_map_markerarray` | `visualization_msgs::msg::MarkerArray` | RViz可视化地图 | 服务响应时发布 |

**代码位置**: `pnc_map_server.cpp` 第27、30、62、67行

#### 1.2 全局路径相关话题
**节点**: `global_path_server_node`  
**命名空间**: `/planning`

| 话题名称 | 消息类型 | 用途 | 发布频率 |
|---------|---------|------|---------|
| `/planning/global_path` | `nav_msgs::msg::Path` | 规划模块使用的全局路径 | 服务响应时发布 |
| `/planning/global_path_rviz` | `visualization_msgs::msg::Marker` | RViz可视化全局路径 | 服务响应时发布 |

**代码位置**: `global_path_server.cpp` 第35、38、79、84行

#### 1.3 规划结果相关话题
**节点**: `planning_process`  
**命名空间**: `/planning`

| 话题名称 | 消息类型 | 用途 | 发布频率 |
|---------|---------|------|---------|
| `/planning/reference_line` | `nav_msgs::msg::Path` | 参考线（用于RViz可视化） | 10Hz (每0.1s) |
| `/planning/local_path` | `nav_msgs::msg::Path` | 局部路径（用于RViz可视化） | 10Hz (每0.1s) |
| `/planning/local_trajectory` | `base_msgs::msg::LocalTrajectory` | 局部轨迹（供执行模块使用） | 10Hz (每0.1s) |

**代码位置**: 
- 发布器创建: `planning_process.cpp` 第72、79、84行
- 发布调用: `planning_process.cpp` 第319、344、362行

### 2. 订阅话题（Subscriber）

#### 2.1 轨迹订阅
**节点**: `car_move_cmd_node`

| 话题名称 | 消息类型 | 用途 | 订阅频率 |
|---------|---------|------|---------|
| `/planning/local_trajectory` | `base_msgs::msg::LocalTrajectory` | 接收规划轨迹，驱动主车运动 | 实时订阅 |

**代码位置**: `car_move_cmd.cpp` 第45-46行

**处理逻辑**:
```cpp
local_trajectory_sub_ = this->create_subscription<LocalTrajectory>(
    "planning/local_trajectory", 
    10, 
    std::bind(&CarMoveCmd::car_broadcast_tf, this, _1)
);
```

### 3. 服务接口（Service）

#### 3.1 PNC地图服务
**服务端**: `pnc_map_server_node`  
**客户端**: `planning_process`

| 服务名称 | 请求类型 | 响应类型 | 用途 |
|---------|---------|---------|------|
| `/planning/pnc_map_service` | `int32 map_type` | `base_msgs::msg::PNCMap` | 请求生成PNC地图 |

**代码位置**:
- 服务端: `pnc_map_server.cpp` 第33-36行
- 客户端: `planning_process.cpp` 第67、228-252行

**请求参数**:
- `map_type = 0`: 直道地图
- `map_type = 1`: S弯地图

#### 3.2 全局路径服务
**服务端**: `global_path_server_node`  
**客户端**: `planning_process`

| 服务名称 | 请求类型 | 响应类型 | 用途 |
|---------|---------|---------|------|
| `/planning/global_path_service` | `int32 global_planner_type + PNCMap` | `nav_msgs::msg::Path` | 请求生成全局路径 |

**代码位置**:
- 服务端: `global_path_server.cpp` 第41-44行
- 客户端: `planning_process.cpp` 第68行

**请求参数**:
- `global_planner_type = 0`: Normal规划器
- `global_planner_type = 1`: A*规划器（预留）

## 数据流图

### 初始化阶段（服务调用）

```
planning_process
    │
    ├─→ [服务调用] /planning/pnc_map_service
    │       │
    │       ↓
    │   pnc_map_server_node
    │       │
    │       ├─→ 生成PNC地图
    │       ├─→ 发布 /planning/pnc_map
    │       └─→ 返回PNCMap (服务响应)
    │
    └─→ [服务调用] /planning/global_path_service
            │
            ↓
        global_path_server_node
            │
            ├─→ 生成全局路径
            ├─→ 发布 /planning/global_path
            └─→ 返回Path (服务响应)
```

### 运行阶段（话题通信）

```
【规划流程】
planning_process (10Hz定时器)
    │
    ├─→ 监听TF (获取车辆位姿)
    ├─→ 生成参考线
    │   └─→ 发布 /planning/reference_line
    │
    ├─→ 决策中心生成SL点
    │
    ├─→ 局部路径规划
    │   └─→ 发布 /planning/local_path
    │
    └─→ 轨迹合成
        └─→ 发布 /planning/local_trajectory
            │
            ↓
【执行流程】
car_move_cmd_node (订阅)
    │
    └─→ 接收轨迹
        └─→ 广播主车TF
            │
            ↓
        planning_process (监听TF)
            └─→ 获取最新位姿，继续规划循环
```

## 话题命名规则

### 命名空间
所有规划相关话题都在 `/planning` 命名空间下，由 `planning_launch.py` 第110行设置：
```python
PushRosNamespace("planning")
```

### 话题命名规范
- 功能话题: `/planning/{功能名}` (如: `reference_line`, `local_path`)
- 可视化话题: `/planning/{功能名}_rviz` 或 `markerarray` (如: `pnc_map_markerarray`)
- 服务: `/planning/{功能名}_service` (如: `pnc_map_service`)

## 消息类型说明

### 自定义消息（base_msgs）
- `PNCMap`: PNC地图数据（中线、左右边界）
- `LocalTrajectory`: 局部轨迹（路径+速度）
- `LocalPath`: 局部路径
- `Referline`: 参考线

### 标准消息
- `nav_msgs::msg::Path`: 路径数据（用于可视化）
- `visualization_msgs::msg::Marker`: 可视化标记
- `visualization_msgs::msg::MarkerArray`: 可视化标记数组

## 通信模式总结

### 1. 服务调用（同步）
- **用途**: 初始化阶段获取地图和全局路径
- **特点**: 阻塞等待，保证数据完整性
- **节点**: `planning_process` → `pnc_map_server` / `global_path_server`

### 2. 话题发布（异步）
- **用途**: 实时发布规划结果
- **特点**: 非阻塞，支持多订阅者
- **频率**: 10Hz (每0.1秒)
- **节点**: `planning_process` 发布，`car_move_cmd` 订阅

### 3. TF变换（坐标系统）
- **用途**: 传递车辆和障碍物位姿
- **特点**: 树状结构，支持坐标变换
- **节点**: 
  - `car_move_cmd`: 广播主车TF
  - `obs_move_cmd`: 广播障碍物TF
  - `planning_process`: 监听TF获取位姿

## 查看话题命令

```bash
# 查看所有规划相关话题
ros2 topic list | grep planning

# 查看话题信息
ros2 topic info /planning/local_trajectory

# 查看话题数据
ros2 topic echo /planning/local_trajectory

# 查看话题发布频率
ros2 topic hz /planning/local_trajectory

# 查看服务
ros2 service list | grep planning
ros2 service type /planning/pnc_map_service
```

## 设计特点

### 1. 模块化通信
- 每个模块独立发布话题，便于解耦
- 服务用于初始化，话题用于实时通信

### 2. 命名空间隔离
- 所有规划话题在 `/planning` 命名空间下
- 避免与其他系统冲突

### 3. 双重发布模式
- 功能数据话题（供其他模块使用）
- 可视化话题（供RViz显示）

### 4. 实时性保证
- 规划结果以10Hz频率发布
- 支持实时轨迹跟踪和执行

